name: Build Static ices0 Binaries

on:
  push:
    branches:
      - main
      - master
  schedule:
    # Monthly on 1st at 00:00 UTC
    - cron: '0 0 1 * *'
  workflow_dispatch:

jobs:
  build-linux:
    name: Build for Linux (${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            alpine_arch: x86_64
          - arch: aarch64
            alpine_arch: aarch64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Alpine Linux
        uses: jirutka/setup-alpine@v1
        with:
          arch: ${{ matrix.alpine_arch }}
          packages: >
            build-base
            autoconf
            automake
            libtool
            pkgconfig
            git
            curl
            tar
            gzip
            bzip2
            xz
            python3-dev
            perl-dev

      - name: Build all dependencies and ices0
        run: |
          set -euo pipefail

          PREFIX="/usr"
          BUILD_DIR="/tmp/ices-build"
          JOBS=$(nproc)

          # Library versions
          ZLIB_VERSION="1.3.1"
          OGG_VERSION="1.3.5"
          VORBIS_VERSION="1.3.7"
          FLAC_VERSION="1.4.3"
          LAME_VERSION="3.100"
          OPENSSL_VERSION="3.2.1"
          LIBXML2_VERSION="2.12.3"

          export PKG_CONFIG_PATH="${PREFIX}/lib/pkgconfig:${PKG_CONFIG_PATH:-}"
          export CFLAGS="-Os -fPIC -static"
          export CXXFLAGS="-Os -fPIC -static"
          export LDFLAGS="-static"

          mkdir -p "${BUILD_DIR}"
          cd "${BUILD_DIR}"

          echo "=========================================="
          echo "Building static dependencies"
          echo "=========================================="

          download_extract() {
            local url="$1"
            local file="$2"
            echo "Downloading ${file}..."
            curl -L -o "${file}" "${url}"
            case "${file}" in
              *.tar.gz|*.tgz) tar xzf "${file}" ;;
              *.tar.xz) tar xJf "${file}" ;;
              *.tar.bz2) tar xjf "${file}" ;;
            esac
          }

          # Build all dependencies
          download_extract "https://zlib.net/zlib-${ZLIB_VERSION}.tar.gz" "zlib.tar.gz"
          cd zlib-${ZLIB_VERSION} && ./configure --prefix="${PREFIX}" --static && make -j${JOBS} && make install && cd ..

          download_extract "https://downloads.xiph.org/releases/ogg/libogg-${OGG_VERSION}.tar.xz" "libogg.tar.xz"
          cd libogg-${OGG_VERSION} && ./configure --prefix="${PREFIX}" --disable-shared --enable-static && make -j${JOBS} && make install && cd ..

          download_extract "https://downloads.xiph.org/releases/vorbis/libvorbis-${VORBIS_VERSION}.tar.xz" "libvorbis.tar.xz"
          cd libvorbis-${VORBIS_VERSION} && ./configure --prefix="${PREFIX}" --disable-shared --enable-static --with-ogg="${PREFIX}" && make -j${JOBS} && make install && cd ..

          download_extract "https://downloads.xiph.org/releases/flac/flac-${FLAC_VERSION}.tar.xz" "flac.tar.xz"
          cd flac-${FLAC_VERSION} && ./configure --prefix="${PREFIX}" --disable-shared --enable-static --with-ogg="${PREFIX}" --disable-programs --disable-examples && make -j${JOBS} && make install && cd ..

          download_extract "https://sourceforge.net/projects/lame/files/lame/${LAME_VERSION}/lame-${LAME_VERSION}.tar.gz/download" "lame.tar.gz"
          cd lame-${LAME_VERSION} && ./configure --prefix="${PREFIX}" --disable-shared --enable-static --enable-nasm --disable-frontend && make -j${JOBS} && make install && cd ..

          git clone --depth 1 https://github.com/knik0/faad2.git
          cd faad2 && autoreconf -fi && ./configure --prefix="${PREFIX}" --disable-shared --enable-static --without-drm && make -j${JOBS} && make install && cd ..

          download_extract "https://www.openssl.org/source/openssl-${OPENSSL_VERSION}.tar.gz" "openssl.tar.gz"
          cd openssl-${OPENSSL_VERSION} && ./config --prefix="${PREFIX}" --openssldir="${PREFIX}/ssl" no-shared no-ssl3 no-weak-ssl-ciphers -static && make -j${JOBS} && make install_sw install_ssldirs && cd ..

          git clone --depth 1 https://gitlab.xiph.org/xiph/icecast-libshout.git
          cd icecast-libshout && autoreconf -fi && ./configure --prefix="${PREFIX}" --disable-shared --enable-static --with-ogg="${PREFIX}" --with-vorbis="${PREFIX}" --with-openssl="${PREFIX}" && make -j${JOBS} && make install && cd ..

          download_extract "https://download.gnome.org/sources/libxml2/2.12/libxml2-${LIBXML2_VERSION}.tar.xz" "libxml2.tar.xz"
          cd libxml2-${LIBXML2_VERSION} && ./configure --prefix="${PREFIX}" --disable-shared --enable-static --without-python --without-readline --without-lzma --without-zstd --with-zlib="${PREFIX}" && make -j${JOBS} && make install && cd ..

          echo "=========================================="
          echo "Building ices0"
          echo "=========================================="

          cd "${BUILD_DIR}"
          git clone https://github.com/Moonbase59/ices0.git
          cd ices0

          VERSION_MAJOR=$(grep -Po 'ICES_MAJOR=\K[0-9]+' configure.ac || echo "0")
          VERSION_MINOR=$(grep -Po 'ICES_MINOR=\K[0-9]+' configure.ac || echo "0")
          VERSION_MICRO=$(grep -Po 'ICES_MICRO=\K[0-9]+' configure.ac || echo "0")
          VERSION="${VERSION_MAJOR}.${VERSION_MINOR}.${VERSION_MICRO}"
          echo "${VERSION}" > VERSION.txt

          export CFLAGS="-Os -I${PREFIX}/include"
          export LDFLAGS="-L${PREFIX}/lib"
          export LIBS="-lshout -lvorbisfile -lvorbis -logg -lFLAC -lmp3lame -lfaad -lxml2 -lssl -lcrypto -lz -lm"

          autoreconf -fi

          ./configure \
            --prefix=/usr \
            --sysconfdir=/etc \
            --with-xml-config="${PREFIX}/bin/xml2-config" \
            --with-lame="${PREFIX}" \
            --with-vorbis="${PREFIX}" \
            --with-faad="${PREFIX}" \
            --with-flac="${PREFIX}" \
            --with-python \
            --with-perl

          make -j${JOBS}
          mv src/ices src/ices0
          strip src/ices0

          echo "Build complete - Version: ${VERSION}"
          ./src/ices0 -V || true
          ldd src/ices0 || echo "Static binary"

        shell: alpine.sh {0}

      - name: Extract version and create artifacts
        run: |
          VERSION=$(cat /tmp/ices-build/ices0/VERSION.txt)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

          cd /tmp/ices-build/ices0/src
          ARCH="${{ matrix.arch }}"
          ARCH="${ARCH%-musl}"
          mv ices0 ices0-linux-${ARCH}
          chmod +x ices0-linux-${ARCH}
        shell: alpine.sh {0}
        id: version

      - name: Create source archive
        if: matrix.arch == 'x86_64'
        run: |
          cd /tmp/ices-build/ices0
          VERSION=$(cat VERSION.txt)
          rm -rf .git .gitignore .github
          cd /tmp/ices-build
          tar czf ices0-${VERSION}-src.tar.gz ices0/
        shell: alpine.sh {0}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ices0-linux-${{ matrix.arch }}
          path: /tmp/ices-build/ices0/src/ices0-linux-${{ matrix.arch }}

      - name: Upload source archive
        if: matrix.arch == 'x86_64'
        uses: actions/upload-artifact@v4
        with:
          name: source-archive
          path: /tmp/ices-build/ices0-*-src.tar.gz

      - name: Upload version
        uses: actions/upload-artifact@v4
        with:
          name: version-linux-${{ matrix.arch }}
          path: /tmp/ices-build/ices0/VERSION.txt

  build-macos:
    name: Build for macOS (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            runner: macos-13
          - arch: arm64
            runner: macos-14

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          brew install autoconf automake libtool pkg-config python3 perl

      - name: Build dependencies and ices0
        run: |
          set -euo pipefail

          PREFIX="/usr/local"
          BUILD_DIR="$HOME/ices-build"
          JOBS=$(sysctl -n hw.ncpu)

          ZLIB_VERSION="1.3.1"
          OGG_VERSION="1.3.5"
          VORBIS_VERSION="1.3.7"
          FLAC_VERSION="1.4.3"
          LAME_VERSION="3.100"
          OPENSSL_VERSION="3.2.1"
          LIBXML2_VERSION="2.12.3"

          export PKG_CONFIG_PATH="${PREFIX}/lib/pkgconfig:${PKG_CONFIG_PATH:-}"
          export CFLAGS="-Os -arch $(uname -m)"
          export LDFLAGS="-L${PREFIX}/lib"

          mkdir -p "${BUILD_DIR}"
          cd "${BUILD_DIR}"

          download_extract() {
            local url="$1"
            local file="$2"
            curl -L -o "${file}" "${url}"
            case "${file}" in
              *.tar.gz|*.tgz) tar xzf "${file}" ;;
              *.tar.xz) tar xJf "${file}" ;;
            esac
          }

          # Build all dependencies (same as Linux)
          download_extract "https://zlib.net/zlib-${ZLIB_VERSION}.tar.gz" "zlib.tar.gz"
          cd zlib-${ZLIB_VERSION} && ./configure --prefix="${PREFIX}" --static && make -j${JOBS} && sudo make install && cd ..

          download_extract "https://downloads.xiph.org/releases/ogg/libogg-${OGG_VERSION}.tar.xz" "libogg.tar.xz"
          cd libogg-${OGG_VERSION} && ./configure --prefix="${PREFIX}" --disable-shared --enable-static && make -j${JOBS} && sudo make install && cd ..

          download_extract "https://downloads.xiph.org/releases/vorbis/libvorbis-${VORBIS_VERSION}.tar.xz" "libvorbis.tar.xz"
          cd libvorbis-${VORBIS_VERSION} && ./configure --prefix="${PREFIX}" --disable-shared --enable-static --with-ogg="${PREFIX}" && make -j${JOBS} && sudo make install && cd ..

          download_extract "https://downloads.xiph.org/releases/flac/flac-${FLAC_VERSION}.tar.xz" "flac.tar.xz"
          cd flac-${FLAC_VERSION} && ./configure --prefix="${PREFIX}" --disable-shared --enable-static --with-ogg="${PREFIX}" --disable-programs && make -j${JOBS} && sudo make install && cd ..

          download_extract "https://sourceforge.net/projects/lame/files/lame/${LAME_VERSION}/lame-${LAME_VERSION}.tar.gz/download" "lame.tar.gz"
          cd lame-${LAME_VERSION} && ./configure --prefix="${PREFIX}" --disable-shared --enable-static --disable-frontend && make -j${JOBS} && sudo make install && cd ..

          git clone --depth 1 https://github.com/knik0/faad2.git
          cd faad2 && autoreconf -fi && ./configure --prefix="${PREFIX}" --disable-shared --enable-static --without-drm && make -j${JOBS} && sudo make install && cd ..

          download_extract "https://www.openssl.org/source/openssl-${OPENSSL_VERSION}.tar.gz" "openssl.tar.gz"
          cd openssl-${OPENSSL_VERSION} && ./config --prefix="${PREFIX}" no-shared && make -j${JOBS} && sudo make install_sw && cd ..

          git clone --depth 1 https://gitlab.xiph.org/xiph/icecast-libshout.git
          cd icecast-libshout && autoreconf -fi && ./configure --prefix="${PREFIX}" --disable-shared --enable-static --with-ogg="${PREFIX}" --with-vorbis="${PREFIX}" --with-openssl="${PREFIX}" && make -j${JOBS} && sudo make install && cd ..

          download_extract "https://download.gnome.org/sources/libxml2/2.12/libxml2-${LIBXML2_VERSION}.tar.xz" "libxml2.tar.xz"
          cd libxml2-${LIBXML2_VERSION} && ./configure --prefix="${PREFIX}" --disable-shared --enable-static --without-python --without-readline --without-lzma --without-zstd && make -j${JOBS} && sudo make install && cd ..

          # Build ices0
          cd "${BUILD_DIR}"
          git clone https://github.com/Moonbase59/ices0.git
          cd ices0

          VERSION_MAJOR=$(grep -Po 'ICES_MAJOR=\K[0-9]+' configure.ac || echo "0")
          VERSION_MINOR=$(grep -Po 'ICES_MINOR=\K[0-9]+' configure.ac || echo "0")
          VERSION_MICRO=$(grep -Po 'ICES_MICRO=\K[0-9]+' configure.ac || echo "0")
          VERSION="${VERSION_MAJOR}.${VERSION_MINOR}.${VERSION_MICRO}"
          echo "${VERSION}" > VERSION.txt

          export LIBS="-lshout -lvorbisfile -lvorbis -logg -lFLAC -lmp3lame -lfaad -lxml2 -lssl -lcrypto -lz -lm"

          autoreconf -fi
          ./configure \
            --prefix=/usr/local \
            --with-xml-config="${PREFIX}/bin/xml2-config" \
            --with-lame="${PREFIX}" \
            --with-vorbis="${PREFIX}" \
            --with-faad="${PREFIX}" \
            --with-flac="${PREFIX}" \
            --with-python \
            --with-perl

          make -j${JOBS}
          mv src/ices src/ices0
          strip src/ices0

          echo "Build complete"
          ./src/ices0 -V || true
          otool -L src/ices0 || true

      - name: Prepare artifacts
        run: |
          cd ~/ices-build/ices0
          VERSION=$(cat VERSION.txt)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          cd src
          mv ices0 ices0-macos-${{ matrix.arch }}
        id: version

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ices0-macos-${{ matrix.arch }}
          path: ~/ices-build/ices0/src/ices0-macos-${{ matrix.arch }}

      - name: Upload version
        uses: actions/upload-artifact@v4
        with:
          name: version-macos-${{ matrix.arch }}
          path: ~/ices-build/ices0/VERSION.txt

  build-windows:
    name: Build for Windows (${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            mingw: x86_64-w64-mingw32
          - arch: aarch64
            mingw: aarch64-w64-mingw32

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install MinGW toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64 autoconf automake libtool pkg-config git curl

      - name: Build dependencies and ices0
        run: |
          set -euo pipefail

          MINGW="${{ matrix.mingw }}"
          PREFIX="/usr/${MINGW}"
          BUILD_DIR="/tmp/ices-build"
          JOBS=$(nproc)

          ZLIB_VERSION="1.3.1"
          OGG_VERSION="1.3.5"
          VORBIS_VERSION="1.3.7"
          FLAC_VERSION="1.4.3"
          LAME_VERSION="3.100"
          OPENSSL_VERSION="3.2.1"
          LIBXML2_VERSION="2.12.3"

          export CC="${MINGW}-gcc"
          export CXX="${MINGW}-g++"
          export AR="${MINGW}-ar"
          export RANLIB="${MINGW}-ranlib"
          export PKG_CONFIG_PATH="${PREFIX}/lib/pkgconfig"
          export CFLAGS="-Os -static"
          export LDFLAGS="-static -static-libgcc"

          mkdir -p "${BUILD_DIR}"
          cd "${BUILD_DIR}"

          download_extract() {
            local url="$1"
            local file="$2"
            curl -L -o "${file}" "${url}"
            case "${file}" in
              *.tar.gz|*.tgz) tar xzf "${file}" ;;
              *.tar.xz) tar xJf "${file}" ;;
            esac
          }

          # Build dependencies
          download_extract "https://zlib.net/zlib-${ZLIB_VERSION}.tar.gz" "zlib.tar.gz"
          cd zlib-${ZLIB_VERSION} && ./configure --prefix="${PREFIX}" --static && make -j${JOBS} && sudo make install && cd ..

          download_extract "https://downloads.xiph.org/releases/ogg/libogg-${OGG_VERSION}.tar.xz" "libogg.tar.xz"
          cd libogg-${OGG_VERSION} && ./configure --host=${MINGW} --prefix="${PREFIX}" --disable-shared --enable-static && make -j${JOBS} && sudo make install && cd ..

          download_extract "https://downloads.xiph.org/releases/vorbis/libvorbis-${VORBIS_VERSION}.tar.xz" "libvorbis.tar.xz"
          cd libvorbis-${VORBIS_VERSION} && ./configure --host=${MINGW} --prefix="${PREFIX}" --disable-shared --enable-static --with-ogg="${PREFIX}" && make -j${JOBS} && sudo make install && cd ..

          download_extract "https://downloads.xiph.org/releases/flac/flac-${FLAC_VERSION}.tar.xz" "flac.tar.xz"
          cd flac-${FLAC_VERSION} && ./configure --host=${MINGW} --prefix="${PREFIX}" --disable-shared --enable-static --with-ogg="${PREFIX}" --disable-programs && make -j${JOBS} && sudo make install && cd ..

          download_extract "https://sourceforge.net/projects/lame/files/lame/${LAME_VERSION}/lame-${LAME_VERSION}.tar.gz/download" "lame.tar.gz"
          cd lame-${LAME_VERSION} && ./configure --host=${MINGW} --prefix="${PREFIX}" --disable-shared --enable-static --disable-frontend && make -j${JOBS} && sudo make install && cd ..

          git clone --depth 1 https://github.com/knik0/faad2.git
          cd faad2 && autoreconf -fi && ./configure --host=${MINGW} --prefix="${PREFIX}" --disable-shared --enable-static --without-drm && make -j${JOBS} && sudo make install && cd ..

          download_extract "https://www.openssl.org/source/openssl-${OPENSSL_VERSION}.tar.gz" "openssl.tar.gz"
          cd openssl-${OPENSSL_VERSION} && ./Configure mingw64 --prefix="${PREFIX}" no-shared --cross-compile-prefix=${MINGW}- && make -j${JOBS} && sudo make install_sw && cd ..

          git clone --depth 1 https://gitlab.xiph.org/xiph/icecast-libshout.git
          cd icecast-libshout && autoreconf -fi && ./configure --host=${MINGW} --prefix="${PREFIX}" --disable-shared --enable-static --with-ogg="${PREFIX}" --with-vorbis="${PREFIX}" --with-openssl="${PREFIX}" && make -j${JOBS} && sudo make install && cd ..

          download_extract "https://download.gnome.org/sources/libxml2/2.12/libxml2-${LIBXML2_VERSION}.tar.xz" "libxml2.tar.xz"
          cd libxml2-${LIBXML2_VERSION} && ./configure --host=${MINGW} --prefix="${PREFIX}" --disable-shared --enable-static --without-python --without-readline --without-lzma --without-zstd && make -j${JOBS} && sudo make install && cd ..

          # Build ices0
          cd "${BUILD_DIR}"
          git clone https://github.com/Moonbase59/ices0.git
          cd ices0

          VERSION_MAJOR=$(grep -Po 'ICES_MAJOR=\K[0-9]+' configure.ac || echo "0")
          VERSION_MINOR=$(grep -Po 'ICES_MINOR=\K[0-9]+' configure.ac || echo "0")
          VERSION_MICRO=$(grep -Po 'ICES_MICRO=\K[0-9]+' configure.ac || echo "0")
          VERSION="${VERSION_MAJOR}.${VERSION_MINOR}.${VERSION_MICRO}"
          echo "${VERSION}" > VERSION.txt

          export LIBS="-lshout -lvorbisfile -lvorbis -logg -lFLAC -lmp3lame -lfaad -lxml2 -lssl -lcrypto -lz -lm -lws2_32"

          autoreconf -fi
          ./configure \
            --host=${MINGW} \
            --prefix=/usr \
            --with-xml-config="${PREFIX}/bin/xml2-config" \
            --with-lame="${PREFIX}" \
            --with-vorbis="${PREFIX}" \
            --with-faad="${PREFIX}" \
            --with-flac="${PREFIX}" \
            --without-python \
            --without-perl

          make -j${JOBS}
          mv src/ices.exe src/ices0.exe 2>/dev/null || mv src/ices src/ices0.exe
          ${MINGW}-strip src/ices0.exe

          echo "Build complete"

      - name: Prepare artifacts
        run: |
          cd /tmp/ices-build/ices0
          VERSION=$(cat VERSION.txt)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          cd src
          mv ices0.exe ices0-windows-${{ matrix.arch }}.exe
        id: version

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ices0-windows-${{ matrix.arch }}
          path: /tmp/ices-build/ices0/src/ices0-windows-${{ matrix.arch }}.exe

      - name: Upload version
        uses: actions/upload-artifact@v4
        with:
          name: version-windows-${{ matrix.arch }}
          path: /tmp/ices-build/ices0/VERSION.txt

  build-freebsd:
    name: Build for FreeBSD (${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            freebsd_arch: amd64
          - arch: aarch64
            freebsd_arch: arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build in FreeBSD VM
        uses: vmactions/freebsd-vm@v1
        with:
          arch: ${{ matrix.freebsd_arch }}
          release: '14.0'
          usesh: true
          prepare: |
            pkg install -y autoconf automake libtool pkgconf git curl python3 perl5
          run: |
            set -e

            PREFIX="/usr/local"
            BUILD_DIR="/tmp/ices-build"
            JOBS=$(sysctl -n hw.ncpu)

            ZLIB_VERSION="1.3.1"
            OGG_VERSION="1.3.5"
            VORBIS_VERSION="1.3.7"
            FLAC_VERSION="1.4.3"
            LAME_VERSION="3.100"
            OPENSSL_VERSION="3.2.1"
            LIBXML2_VERSION="2.12.3"

            export PKG_CONFIG_PATH="${PREFIX}/lib/pkgconfig"
            export CFLAGS="-Os"
            export LDFLAGS="-L${PREFIX}/lib"

            mkdir -p "${BUILD_DIR}"
            cd "${BUILD_DIR}"

            download_extract() {
              curl -L -o "$2" "$1"
              case "$2" in
                *.tar.gz) tar xzf "$2" ;;
                *.tar.xz) tar xJf "$2" ;;
              esac
            }

            # Build dependencies (same pattern as others)
            download_extract "https://zlib.net/zlib-${ZLIB_VERSION}.tar.gz" "zlib.tar.gz"
            cd zlib-${ZLIB_VERSION} && ./configure --prefix="${PREFIX}" --static && make -j${JOBS} && make install && cd ..

            download_extract "https://downloads.xiph.org/releases/ogg/libogg-${OGG_VERSION}.tar.xz" "libogg.tar.xz"
            cd libogg-${OGG_VERSION} && ./configure --prefix="${PREFIX}" --disable-shared --enable-static && make -j${JOBS} && make install && cd ..

            download_extract "https://downloads.xiph.org/releases/vorbis/libvorbis-${VORBIS_VERSION}.tar.xz" "libvorbis.tar.xz"
            cd libvorbis-${VORBIS_VERSION} && ./configure --prefix="${PREFIX}" --disable-shared --enable-static --with-ogg="${PREFIX}" && make -j${JOBS} && make install && cd ..

            download_extract "https://downloads.xiph.org/releases/flac/flac-${FLAC_VERSION}.tar.xz" "flac.tar.xz"
            cd flac-${FLAC_VERSION} && ./configure --prefix="${PREFIX}" --disable-shared --enable-static --with-ogg="${PREFIX}" --disable-programs && make -j${JOBS} && make install && cd ..

            download_extract "https://sourceforge.net/projects/lame/files/lame/${LAME_VERSION}/lame-${LAME_VERSION}.tar.gz/download" "lame.tar.gz"
            cd lame-${LAME_VERSION} && ./configure --prefix="${PREFIX}" --disable-shared --enable-static --disable-frontend && make -j${JOBS} && make install && cd ..

            git clone --depth 1 https://github.com/knik0/faad2.git
            cd faad2 && autoreconf -fi && ./configure --prefix="${PREFIX}" --disable-shared --enable-static --without-drm && make -j${JOBS} && make install && cd ..

            download_extract "https://www.openssl.org/source/openssl-${OPENSSL_VERSION}.tar.gz" "openssl.tar.gz"
            cd openssl-${OPENSSL_VERSION} && ./config --prefix="${PREFIX}" no-shared && make -j${JOBS} && make install_sw && cd ..

            git clone --depth 1 https://gitlab.xiph.org/xiph/icecast-libshout.git
            cd icecast-libshout && autoreconf -fi && ./configure --prefix="${PREFIX}" --disable-shared --enable-static --with-ogg="${PREFIX}" --with-vorbis="${PREFIX}" --with-openssl="${PREFIX}" && make -j${JOBS} && make install && cd ..

            download_extract "https://download.gnome.org/sources/libxml2/2.12/libxml2-${LIBXML2_VERSION}.tar.xz" "libxml2.tar.xz"
            cd libxml2-${LIBXML2_VERSION} && ./configure --prefix="${PREFIX}" --disable-shared --enable-static --without-python --without-readline --without-lzma --without-zstd && make -j${JOBS} && make install && cd ..

            # Build ices0
            cd "${BUILD_DIR}"
            git clone https://github.com/Moonbase59/ices0.git
            cd ices0

            VERSION_MAJOR=$(grep -E 'ICES_MAJOR=' configure.ac | grep -oE '[0-9]+' | head -1)
            VERSION_MINOR=$(grep -E 'ICES_MINOR=' configure.ac | grep -oE '[0-9]+' | head -1)
            VERSION_MICRO=$(grep -E 'ICES_MICRO=' configure.ac | grep -oE '[0-9]+' | head -1)
            VERSION="${VERSION_MAJOR}.${VERSION_MINOR}.${VERSION_MICRO}"
            echo "${VERSION}" > VERSION.txt

            export LIBS="-lshout -lvorbisfile -lvorbis -logg -lFLAC -lmp3lame -lfaad -lxml2 -lssl -lcrypto -lz -lm"

            autoreconf -fi
            ./configure \
              --prefix=/usr/local \
              --with-xml-config="${PREFIX}/bin/xml2-config" \
              --with-lame="${PREFIX}" \
              --with-vorbis="${PREFIX}" \
              --with-faad="${PREFIX}" \
              --with-flac="${PREFIX}" \
              --with-python \
              --with-perl

            make -j${JOBS}
            mv src/ices src/ices0
            strip src/ices0

            cd src
            mv ices0 ices0-freebsd-${{ matrix.arch }}

            echo "Build complete"
            ./ices0-freebsd-${{ matrix.arch }} -V || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ices0-freebsd-${{ matrix.arch }}
          path: /tmp/ices-build/ices0/src/ices0-freebsd-${{ matrix.arch }}

      - name: Upload version
        uses: actions/upload-artifact@v4
        with:
          name: version-freebsd-${{ matrix.arch }}
          path: /tmp/ices-build/ices0/VERSION.txt

  create-release:
    name: Create Release
    needs: [build-linux, build-macos, build-windows, build-freebsd]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Get version
        id: version
        run: |
          VERSION=$(cat artifacts/version-linux-x86_64/VERSION.txt)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"

      - name: Organize artifacts
        run: |
          mkdir -p release
          find artifacts -name 'ices0-*' -type f -exec cp {} release/ \;
          ls -lh release/

      - name: Create checksums
        run: |
          cd release
          sha256sum ices0-* > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Delete existing release
        run: |
          if gh release view "v${{ steps.version.outputs.version }}" &> /dev/null; then
            echo "Deleting existing release v${{ steps.version.outputs.version }}"
            gh release delete "v${{ steps.version.outputs.version }}" -y
            git push --delete origin "v${{ steps.version.outputs.version }}" || true
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: ices0 v${{ steps.version.outputs.version }}
          body: |
            # ices0 v${{ steps.version.outputs.version }} - Multi-Platform Static Binaries

            Truly static binaries for ices0 with all features enabled.

            ## Features

            ✅ XML configuration (libxml2)
            ✅ MP3 re-encoding (LAME)
            ✅ Vorbis transcoding
            ✅ FLAC transcoding
            ✅ MP4/AAC transcoding (FAAD2)
            ✅ TLS/SSL support (OpenSSL)
            ✅ UTF-8 metadata handling
            ✅ Python/Perl scripting (dynamic - requires runtime on user system)

            ## Downloads

            ### Linux (fully static with musl)
            - [ices0-linux-x86_64](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/ices0-linux-x86_64)
            - [ices0-linux-aarch64](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/ices0-linux-aarch64)

            ### macOS (near-static)
            - [ices0-macos-x86_64](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/ices0-macos-x86_64)
            - [ices0-macos-arm64](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/ices0-macos-arm64)

            ### Windows (static)
            - [ices0-windows-x86_64.exe](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/ices0-windows-x86_64.exe)
            - [ices0-windows-aarch64.exe](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/ices0-windows-aarch64.exe)

            ### FreeBSD (static)
            - [ices0-freebsd-x86_64](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/ices0-freebsd-x86_64)
            - [ices0-freebsd-aarch64](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/ices0-freebsd-aarch64)

            ### Source Archive
            - [ices0-${{ steps.version.outputs.version }}-src.tar.gz](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/ices0-${{ steps.version.outputs.version }}-src.tar.gz)

            ## Verification

            [SHA256SUMS.txt](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/SHA256SUMS.txt)

            ```bash
            sha256sum -c SHA256SUMS.txt --ignore-missing
            ```

            ## Python/Perl Support

            These builds have Python/Perl features compiled in but dynamically linked. Install Python3/Perl on your system to use scripting features. Binaries work fine without them.

            ---

            **Source**: [Moonbase59/ices0](https://github.com/Moonbase59/ices0)
          files: release/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
